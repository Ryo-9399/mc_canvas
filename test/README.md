# テストについて
この`test`ディレクトリには、**自動自動正男テスト**のためのファイルが入っています。

テストの手法は、正男のソースコードを変更したときに既存の正男の挙動が変わってしまわないことを確かめるために、自動正男を動作させてその挙動をチェックするというものです。**自動自動正男テスト**は、この一連の処理を自動で行うものです。

## テストの方法
1. `npm install`を実行します。（初回のみ。必要なモジュールがローカルインストールされます。）
2. `npm test`を実行します。
3. SUCCESSと表示されればテスト成功です。ERRORと表示された場合は失敗です。

### スナップショットテスト
自動自動正男テストではスナップショットテストを行っています。これは、ゲームの途中の内部状態（スナップショット）をあらかじめ保存しておき、テストの際に正男を動かして同じ内部状態が再現することを確かめるものです。

ただし、1フレーム分のスナップショットが約300KBあるため全フレームのスナップショットを全て取っておくことは不可能です。そのため、自動正男1つにつき3つ程度のフレームを選出してスナップショットを取っています。テスト対象のフレームとしては、ゲーム動作中の適当なタイミングに加えて、クリア画面が表示されているフレームを1つ選ぶことを推奨します。これにより、ゲームクリアまでのフレーム数が一致することをスナップショットテストにより確かめることができます。

テスト失敗時にスナップショットの相違点を表示するには、`DIFF=1 npm test`を実行します。

スナップショットを変更したい場合、すなわちソースコードの変更の結果として正男の挙動が変化したもののそちらが正しいという場合には、`UPDATE=1 npm test`を実行します。

## ファイル構成
- `karma.conf.js`: テストランナーであるkarmaの設定ファイルです。
- `__tests__/index.js`: テストの本体が記述されたファイルです。
- `__tests__/stages`: テスト対象の自動正男が入っているディレクトリです。個々の正男は`*.masao.json`という名前のファイルとなっています。
- `__tests__/stages/__snapshots__`: スナップショットが入っているディレクトリです。

## 自動正男の追加方法
テスト対象として新しい自動正男を追加するには、`*.masao.json`ファイルを作成して所定のディレクトリを追加します。このファイルでは正男のデータに加えてスナップショットを取るフレーム数を記述します。その後`npm test`を実行するとスナップショットが作成されます。

## 謝辞
テストに使用されている自動正男は下記のものです。

- `hokanozidou54.masao.json`: [ドッスンスンだらけ2 - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou54.html)
- `hokanozidou59.masao.json`: [曲線の床を走り抜けて - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou59.html)
- `hokanozidou74.masao.json`: [3ステージボス戦全自動 - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou74.html)
- `hokanozidou75.masao.json`: [ドッスンスンを動かして2 - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou75.html)
- `hokanozidou87.masao.json`: [人間大砲＜バネ - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou87.html)
- `hokanozidou92.masao.json`: [坂道で急上昇 - !のウェブサイト](http://bi.81.la/masao/hokanozidou/hokanozidou92.html)

- `uzushio.masao.json`: 作者: !
